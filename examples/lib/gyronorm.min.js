(function(root,factory){if(typeof define==="function"&&define.amd){define(function(){return root.GyroNorm=factory()})}else if(typeof module==="object"&&module.exports){module.exports=root.GyroNorm=factory()}else{root.GyroNorm=factory()}})(this,function(){var _interval=null;var _isCalibrating=false;var _calibrationValues=new Array;var _calibrationValue=0;var _gravityCoefficient=0;var _logger=null;var _ready=null;var _deviceOrientationAvailable=false;var _accelerationAvailable=false;var _accelerationIncludingGravityAvailable=false;var _rotationRateAvailable=false;var _compassNeedsCalibrationAvailable=false;var _addedEventCounter=0;var _devicemotionCheckFlag=false;var _deviceorientationCheckFlag=false;var _devicemotionCallbackCount=0;var _deviceorientationCallbackCount=0;var _eventInitialCallbackLimit=2;var _readyGracePeriod=5e3;var _readyGracePeriodTimeout=null;var _frequency=50;var _gravityNormalized=true;var _directionAbsolute=false;var _decimalCount=2;var _values={"do":{alpha:0,beta:0,gamma:0,absolute:false},dm:{x:0,y:0,z:0,gx:0,gy:0,gz:0,alpha:0,beta:0,gamma:0}};var GyroNorm=function(options){if(options&&options.frequency)_frequency=options.frequency;if(options&&options.gravityNormalized)_gravityNormalized=options.gravityNormalized;if(options&&options.directionAbsolute)_directionAbsolute=options.directionAbsolute;if(options&&options.decimalCount)_decimalCount=options.decimalCount;if(options&&options.logger)_logger=options.logger;if(options&&options.ready)_ready=options.ready;try{calibrate();setupListeners()}catch(err){log(err)}};GyroNorm.prototype.end=function(){try{this.stop();window.removeEventListener("deviceorientation",onDeviceOrientationHandler);window.removeEventListener("devicemotion",onDeviceMotionHandler);window.removeEventListener("compassneedscalibration",onCompassNeedsCalibrationHandler)}catch(err){log(err)}};GyroNorm.prototype.start=function(callback){calibrate();_interval=setInterval(function(){callback(snapShot())},_frequency)};GyroNorm.prototype.stop=function(){if(_interval){clearInterval(_interval)}};GyroNorm.prototype.normalizeGravity=function(flag){_gravityNormalized=flag?true:false};GyroNorm.prototype.giveAbsoluteDirection=function(flag){_directionAbsolute=flag?true:false};GyroNorm.prototype.setHeadDirection=function(){_directionAbsolute=false;calibrate()};GyroNorm.prototype.startLogging=function(logger){if(logger){_logger=logger}};GyroNorm.prototype.stopLogging=function(){_logger=null};GyroNorm.prototype.isAvailable=function(_eventType){switch(_eventType){case"deviceorientation":return _deviceOrientationAvailable;break;case"acceleration":return _accelerationAvailable;break;case"accelerationinludinggravity":return _accelerationIncludingGravityAvailable;break;case"rotationrate":return _rotationRateAvailable;break;case"compassneedscalibration":return _compassNeedsCalibrationAvailable;break;default:return{deviceOrientationAvailable:_deviceOrientationAvailable,accelerationAvailable:_accelerationAvailable,accelerationIncludingGravityAvailable:_accelerationIncludingGravityAvailable,rotationRateAvailable:_rotationRateAvailable,compassNeedsCalibrationAvailable:_compassNeedsCalibrationAvailable};break}};function setupListeners(){if(window.ondeviceorientation===undefined){onEventAddedHandler()}else{window.addEventListener("deviceorientation",onDeviceOrientationHandler)}if(window.ondevicemotion===undefined){onEventAddedHandler()}else{window.addEventListener("devicemotion",onDeviceMotionHandler)}if(window.oncompassneedscalibration===undefined){onEventAddedHandler()}else{window.addEventListener("compassneedscalibration",onCompassNeedsCalibrationHandler)}_readyGracePeriodTimeout=setTimeout(onReadyGracePeriodComplete,_readyGracePeriod)}function updateCalibration(){if(_calibrationValues.length>19){_calibrationValues.splice(0,5);var total=0;for(var i=0;i<_calibrationValues.length;i++){total+=_calibrationValues[i]}_calibrationValue=parseInt(total/15);_isCalibrating=false}}function onDeviceOrientationHandler(event){if(_deviceorientationCallbackCount<_eventInitialCallbackLimit){_deviceorientationCallbackCount++;return}if((!event.alpha||event.alpha===null)&&(!event.beta||event.beta===null)&&(!event.gamma||event.gamma===null)){window.removeEventListener("deviceorientation",onDeviceOrientationHandler);onEventAddedHandler();return}if(_isCalibrating){_calibrationValues.push(event.alpha);updateCalibration();return}_values.do.alpha=event.alpha;_values.do.beta=event.beta;_values.do.gamma=event.gamma;_values.do.absolute=event.absolute;if(!_deviceorientationCheckFlag){_deviceOrientationAvailable=true;_deviceorientationCheckFlag=true;onEventAddedHandler()}}function onDeviceMotionHandler(event){if(_devicemotionCallbackCount<_eventInitialCallbackLimit){_devicemotionCallbackCount++;return}if(!_devicemotionCheckFlag){if(event.acceleration&&event.acceleration.x&&event.acceleration.y&&event.acceleration.z){_accelerationAvailable=true}if(event.accelerationIncludingGravity&&event.accelerationIncludingGravity.x&&event.accelerationIncludingGravity.y&&event.accelerationIncludingGravity.z){_accelerationIncludingGravityAvailable=true}if(event.rotationRate&&event.rotationRate.alpha&&event.rotationRate.beta&&event.rotationRate.gamma){_rotationRateAvailable=true}if(!_accelerationAvailable&&!_accelerationIncludingGravityAvailable&&!_rotationRateAvailable){window.removeEventListener("devicemotion",onDeviceMotionHandler)}onEventAddedHandler();_devicemotionCheckFlag=true}if(_gravityCoefficient==0){_gravityCoefficient=parseInt(event.accelerationIncludingGravity.z)<0?1:-1;return}_values.dm.x=event.acceleration.x;_values.dm.y=event.acceleration.y;_values.dm.z=event.acceleration.z;_values.dm.gx=event.accelerationIncludingGravity.x;_values.dm.gy=event.accelerationIncludingGravity.y;_values.dm.gz=event.accelerationIncludingGravity.z;_values.dm.alpha=event.rotationRate.alpha;_values.dm.beta=event.rotationRate.beta;_values.dm.gamma=event.rotationRate.gamma}function onCompassNeedsCalibrationHandler(event){log({message:"Compass is not calibrated.",code:3});onEventAddedHandler()}function onEventAddedHandler(){_addedEventCounter++;if(_addedEventCounter===3&&_ready!==null&&typeof _ready==="function"){window.clearTimeout(_readyGracePeriodTimeout);_ready()}}function onReadyGracePeriodComplete(){_addedEventCounter=2;onEventAddedHandler()}function rnd(number){return Math.round(number*Math.pow(10,_decimalCount))/Math.pow(10,_decimalCount)}function calibrate(){_isCalibrating=true;_calibrationValues=new Array}function snapShot(){var alphaToSend=0;if(!_directionAbsolute){alphaToSend=_values.do.alpha-_calibrationValue;alphaToSend=alphaToSend<0?360-Math.abs(alphaToSend):alphaToSend}else{alphaToSend=_values.do.alpha}var snapShot={"do":{alpha:rnd(alphaToSend),beta:rnd(_values.do.beta),gamma:rnd(_values.do.gamma),absolute:_values.do.absolute},dm:{x:rnd(_values.dm.x),y:rnd(_values.dm.y),z:rnd(_values.dm.z),gx:rnd(_values.dm.gx),gy:rnd(_values.dm.gy),gz:rnd(_values.dm.gz),alpha:rnd(_values.dm.alpha),beta:rnd(_values.dm.beta),gamma:rnd(_values.dm.gamma)}};if(_gravityNormalized){snapShot.dm.gx*=_gravityCoefficient;snapShot.dm.gy*=_gravityCoefficient;snapShot.dm.gz*=_gravityCoefficient}return snapShot}function log(err){if(_logger){if(typeof err=="string"){err={message:err,code:0}}_logger(err)}}return GyroNorm});